---
- name: Set up web server container with PHP site
  hosts: web
  become: true
  vars:
    db_host: "{{ hostvars['db-vm'].ansible_host }}"
    db_user: "{{ ansible_user }}"
    ansible_become_password: 123

  tasks:
    - name: Check if Docker is installed
      command: docker --version
      register: docker_installed
      ignore_errors: true

    - name: Install Docker
      become: yes
      block:
        - name: Update apt (initial)
          apt:
            update_cache: yes

        - name: Install necessary packages
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
            state: present

        - name: Add Docker GPG key
          shell: |
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg
          args:
            creates: /etc/apt/keyrings/docker.gpg

        - name: Add Docker apt repository
          shell: |
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          args:
            creates: /etc/apt/sources.list.d/docker.list

        - name: Update apt (post-repo add)
          apt:
            update_cache: yes

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes
      when: docker_installed.failed

    - name: Install Python3 requests and pip on remote VM
      apt:
        name:
          - python3-pip
          - python3-requests
        state: present
        update_cache: yes

    - name: Pull and run webserver container
      community.docker.docker_container:
        name: toi-toi-web
        image: de1vidas/test-custom-nginxphp-virt:latest
        state: started
        restart_policy: unless-stopped
        recreate: true
        published_ports:
          - "80:80"
        env:
          DB_HOST: "{{ hostvars['db-vm'].ansible_host }}"
          DB_USER: "{{ ansible_user }}"
